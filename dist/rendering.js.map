{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","google","visualization","charts","load","packages","events","on","render","legendType","setTimeout","getLegendHeight","panelHeight","css","legend","show","percentage","values","breakPoint","parseInt","total","length","Math","min","floor","setElementHeight","height","e","console","log","formatter","label","slice","slice_data","decimal","start","fontSize","color","percentageDecimals","formatValue","percent","toFixed","noDataPoints","html","addSankey","width","size","plotCanvas","plotCss","top","margin","position","paddingBottom","backgroundColor","options","series","pie","stroke","parseFloat","strokeWidth","highlight","opacity","combine","threshold","grid","hoverable","clickable","pieType","innerRadius","i","hiddenSeries","stack","sort","valueName","sortDesc","a","b","legendData","Object","keys","data1","DataTable","addColumn","jsonObject","forEach","element","labelArray","split","hasOwnProperty","tempValue","value","key","addRows","source","target","chart","Sankey","draw","incrementRenderCounter","renderingCompleted","_"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  elem = elem.find('.sankey-panel');\n  var $tooltip = $('<div id=\"tooltip\">');\n\n  if ((typeof google === 'undefined') || (typeof google.visualization === 'undefined')) {\n    google.charts.load(\"current\", {packages:[\"sankey\"]});\n  }\n\n  ctrl.events.on('render', function() {\n    render(false);\n    if (panel.legendType === 'Right side') {\n      setTimeout(function () { render(true); }, 50);\n    }\n  });\n\n  function getLegendHeight(panelHeight) {\n    $('.graph-legend').css('padding-top', 6);\n    if (!ctrl.panel.legend.show || ctrl.panel.legendType === 'Right side' /*|| ctrl.panel.legendType === 'On graph'*/) {\n      return 0;\n    }\n\n    if (ctrl.panel.legendType == 'Under graph' && ctrl.panel.legend.percentage || ctrl.panel.legend.values) {\n      let breakPoint = parseInt(ctrl.panel.breakPoint) / 100;\n      var total = 23 + 20 * data.length;\n      return Math.min(total, Math.floor(panelHeight * breakPoint));\n    }\n\n    return 27;\n  }\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height - getLegendHeight(ctrl.height);\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch (e) { // IE throws errors sometimes\n      console.log(e);\n      return false;\n    }\n  }\n\n  function formatter(label, slice) {\n    var slice_data = slice.data[0][slice.data[0].length - 1];\n    var decimal = 2;\n    var start = \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\";\n\n    if (ctrl.panel.legend.percentageDecimals) {\n      decimal = ctrl.panel.legend.percentageDecimals;\n    }\n    if (ctrl.panel.legend.values && ctrl.panel.legend.percentage) {\n      return start + ctrl.formatValue(slice_data) + \"<br/>\" + slice.percent.toFixed(decimal) + \"%</div>\";\n    } else if (ctrl.panel.legend.values) {\n      return start + ctrl.formatValue(slice_data) + \"</div>\";\n    } else if (ctrl.panel.legend.percentage) {\n      return start + slice.percent.toFixed(decimal) + \"%</div>\";\n    } else {\n      return start + '</div>';\n    }\n  }\n\n  function noDataPoints() {\n    var html = '<div class=\"datapoints-warning\"><span class=\"small\">No data points</span></div>';\n    elem.html(html);\n  }\n\n  function addSankey() {\n            \n    var width = elem.width();\n    var height = ctrl.height - getLegendHeight(ctrl.height);\n\n    var size = Math.min(width, height);\n\n    var plotCanvas = $('<div></div>');\n    var plotCss = {\n      top: '10px',\n      margin: 'auto',\n      position: 'relative',\n      paddingBottom: 20 + 'px',\n      height: size + 'px'\n    };\n\n    plotCanvas.css(plotCss);\n\n    var backgroundColor = $('body').css('background-color')\n\n    var options = {\n      legend: {\n        show: false\n      },\n      series: {\n        pie: {\n          show: true,\n          stroke: {\n            color: backgroundColor,\n            width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\n          },\n          label: {\n            show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\n            formatter: formatter\n          },\n          highlight: {\n            opacity: 0.0\n          },\n          combine: {\n            threshold: ctrl.panel.combine.threshold,\n            label: ctrl.panel.combine.label\n          }\n        }\n      },\n      grid: {\n        hoverable: true,\n        clickable: false\n      }\n    };\n\n    if (panel.pieType === 'donut') {\n      options.series.pie.innerRadius = 0.5;\n    }\n\n    data = ctrl.data;\n\n    for (let i = 0; i < data.length; i++) {\n      let series = data[i];\n\n      // if hidden remove points\n      if (ctrl.hiddenSeries[series.label]) {\n        series.data = {};\n        series.stack = false;\n      }\n    }\n\n\n    if (panel.legend.sort) {\n      if (ctrl.panel.valueName !== panel.legend.sort) {\n        panel.legend.sort = ctrl.panel.valueName;\n      }\n      if (panel.legend.sortDesc === true) {\n        data.sort(function (a, b) {\n          return b.legendData - a.legendData;\n        });\n      } else {\n        data.sort(function (a, b) {\n          return a.legendData - b.legendData;\n        });\n      }\n    }\n\n    elem.html(plotCanvas);\n\n    if(data.length !== 0 && Object.keys(data[0]).length !== 0){\n\n      var data1 = new google.visualization.DataTable();\n      data1.addColumn('string', 'From');\n      data1.addColumn('string', 'To');\n      data1.addColumn('number', 'Count');\n      var jsonObject={};\n      data.forEach(function(element) {\n        var labelArray = element.label.split(\"---\");\n        for (var i = 0; i < labelArray.length-1; i++) {\n          if(jsonObject.hasOwnProperty(labelArray[i]+\"---\"+labelArray[i+1])){\n            let tempValue = jsonObject[labelArray[i]+\"---\"+labelArray[i+1]].value;\n            jsonObject[labelArray[i]+\"---\"+labelArray[i+1]].value = element.data + tempValue;\n          } else {\n            jsonObject[labelArray[i]+\"---\"+labelArray[i+1]]={\n              \"source\":labelArray[i],\n              \"target\":labelArray[i+1],\n              \"value\":element.data\n      }\n          }\n        }\n/*\n      var body;\n      var percent = parseFloat(item.series.percent).toFixed(2);\n      var formatted = ctrl.formatValue(item.series.data[0][1]);\n\n      body = '<div class=\"piechart-tooltip-small\"><div class=\"piechart-tooltip-time\">';\n      body += '<div class=\"piechart-tooltip-value\">' + item.series.label + ': ' + formatted;\n      body += \" (\" + percent + \"%)\" + '</div>';\n      body += \"</div></div>\";\n\n      $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);*/\n    });\n  \n      for (var key in jsonObject) {\n        data1.addRows([\n          [ jsonObject[key].source, jsonObject[key].target, jsonObject[key].value ]\n        ]);\n      }\n\n      // Set chart options\n      var options = {\n        width: '100%',\n        height: height,\n      };\n\n      // Instantiate and draw our sankey, passing in some options.\n      var chart = new google.visualization.Sankey(elem['0']);\n      chart.draw(data1, options); \n    \n  }\n\n  }\n\n  function render(incrementRenderCounter) {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      //console.log(\"ctrl.data.length - \"+ctrl.data.length);\n      if (0 == ctrl.data.length) {\n        noDataPoints();\n      } else {\n        addSankey();\n      }\n    }\n    if (incrementRenderCounter) {\n      ctrl.renderingCompleted();\n    }\n  }\n}\n\n"]}