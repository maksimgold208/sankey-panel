{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","google","visualization","charts","load","packages","events","on","render","legendType","setTimeout","getLegendHeight","panelHeight","css","legend","show","percentage","values","total","length","Math","min","floor","setElementHeight","height","e","console","log","formatter","label","slice","slice_data","decimal","start","fontSize","color","percentageDecimals","formatValue","percent","toFixed","noDataPoints","html","addSankey","width","size","plotCanvas","plotCss","top","margin","position","backgroundColor","i","series","hiddenSeries","stack","sort","sortDesc","a","b","Object","keys","data1","DataTable","addColumn","forEach","element","addRows","split","sankey","d3","nodeWidth","nodePadding","path","options","chart","Sankey","draw","incrementRenderCounter","renderingCompleted","_"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  elem = elem.find('.sankey-panel');\n  var $tooltip = $('<div id=\"tooltip\">');\n\n  if ((typeof google === 'undefined') || (typeof google.visualization === 'undefined')) {\n    google.charts.load(\"current\", {packages:[\"sankey\"]});\n  }\n\n  ctrl.events.on('render', function() {\n    render(false);\n    if(panel.legendType === 'Right side') {\n      setTimeout(function() { render(true); }, 50);\n    }\n  });\n\n  function getLegendHeight(panelHeight) {\n    $('.graph-legend').css('padding-top', 6);\n    if (!ctrl.panel.legend.show || ctrl.panel.legendType === 'Right side' /*|| ctrl.panel.legendType === 'On graph'*/) {\n      return 0;\n    }\n\n    if (ctrl.panel.legend.percentage || ctrl.panel.legend.values) {\n      var total = 25 + (21 * data.length);\n      return  Math.min(total, Math.floor(panelHeight/2));\n    }\n\n    return 27;\n  }\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height - getLegendHeight(ctrl.height);\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch (e) { // IE throws errors sometimes\n      console.log(e);\n      return false;\n    }\n  }\n\n  function formatter(label, slice) {\n    var slice_data = slice.data[0][slice.data[0].length - 1];\n    var decimal = 2;\n    var start = \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\";\n\n    if(ctrl.panel.legend.percentageDecimals) {\n      decimal = ctrl.panel.legend.percentageDecimals;\n    }\n    if (ctrl.panel.legend.values && ctrl.panel.legend.percentage) {\n      return start + ctrl.formatValue(slice_data) + \"<br/>\" + slice.percent.toFixed(decimal) +\"%</div>\";\n    } else if (ctrl.panel.legend.values) {\n      return start + ctrl.formatValue(slice_data) + \"</div>\";\n    } else if (ctrl.panel.legend.percentage) {\n      return start + slice.percent.toFixed(decimal) + \"%</div>\";\n    } else {\n      return start + '</div>';\n    }\n  }\n\n  function noDataPoints() {\n    var html = '<div class=\"datapoints-warning\"><span class=\"small\">No data points</span></div>';\n    elem.html(html);\n  }\n\n  function addSankey() {\n            \n    var width = elem.width();\n    var height = elem.height();\n    var size = Math.min(width, height);\n\n    var plotCanvas = $('<div></div>');\n    var plotCss = {\n      top: '10px',\n      margin: 'auto',\n      position: 'relative',\n      height: (size - 20) + 'px'\n    };\n\n    plotCanvas.css(plotCss);\n\n    var backgroundColor = $('body').css('background-color')\n\n    data = ctrl.data;\n\n    for (let i = 0; i < data.length; i++) {\n      let series = data[i];\n\n      // if hidden remove points and disable stack\n      if (ctrl.hiddenSeries[series.label]) {\n        series.data = {};\n        series.stack = false;\n      }\n    }\n\n    if (panel.legend.sort) {\n      if (panel.legend.sortDesc === true) {\n        data.sort(function(a, b) {\n          return b.data - a.data;\n        });\n      } else {\n        data.sort(function(a, b){\n          return a.data - b.data;\n        });\n      }\n    }\n\n    elem.html(plotCanvas);\n  \n    if(data.length !== 0 && Object.keys(data[0]).length !== 0){\n\n      var data1 = new google.visualization.DataTable();\n      data1.addColumn('string', 'From');\n      data1.addColumn('string', 'To');\n      data1.addColumn('number', 'Count');\n      \n      data.forEach(function(element) {\n        data1.addRows([\n          [ element.label.split(\"---\")[0], element.label.split(\"---\")[1], element.data ]\n        ]);\n      });\n      // Set the sankey diagram properties\nvar sankey = d3.sankey()\n.nodeWidth(36)\n.nodePadding(40)\n.size([width, height]);\n\nvar path = sankey.link();\nconsole.log(\"================================================\");\nconsole.log(path);\n      // Set chart options\n      var options = {\n        width: '100%',\n        height: height,\n      };\n\n      // Instantiate and draw our sankey, passing in some options.\n      var chart = new google.visualization.Sankey(elem['0']);\n      chart.draw(data1, options); \n    \n    }\n\n\n    //plotSankeyDiagram(data);\n    \n  }\n\n  function render(incrementRenderCounter) {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      //console.log(\"ctrl.data.length - \"+ctrl.data.length);\n      if (0 == ctrl.data.length) {\n        noDataPoints();\n      } else {\n        addSankey();\n      }\n    }\n    if (incrementRenderCounter) {\n      ctrl.renderingCompleted();\n    }\n  }\n}\n\n"]}